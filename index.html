<!DOCTYPE html>
<html>
<head>
    <title>kidoju.integration.designmode</title>
    <script>
        window.app = { DEBUG: true };
    </script>
    <!--link href="//cdn.kendostatic.com/2015.1.318/styles/kendo.common.min.css" rel="stylesheet">
    <link href="//cdn.kendostatic.com/2015.1.318/styles/kendo.default.min.css" rel="stylesheet"-->
    <link href="./styles/vendor/kendo/kendo.common.min.css" rel="stylesheet">
    <link href="./styles/vendor/kendo/kendo.default.min.css" rel="stylesheet">
    <link href="./styles/vendor/kendo/kendo.default.mobile.min.css" rel="stylesheet">
    <!--script src="//code.jquery.com/jquery-1.9.1.min.js"></script-->
    <script src="./js/vendor/jquery.min.js"></script>
    <!--script src="//cdn.kendostatic.com/2015.1.318/js/kendo.all.min.js"></script-->
    <script src="./js/vendor/kendo/kendo.all.min.js"></script>
    <!--script src="../temp/2015.1.318/src/src/kendo.core.js"></script>
    <script src="../temp/2015.1.318/src/src/kendo.data.js"></script>
    <script src="../temp/2015.1.318/src/src/kendo.binder.js"></script-->
    <!-- Code mirror -->
    <link rel="stylesheet" href="./styles/vendor/kendo/codemirror/lib/codemirror.css">
    <link rel="stylesheet" href="./styles/vendor/kendo/codemirror/addon/lint/lint.css">
    <script src="./js/vendor/codemirror/lib/codemirror.js"></script>
    <script src="./js/vendor/codemirror/mode/javascript/javascript.js"></script>
    <script src="./js/vendor/codemirror/addon/lint/jshint.js"></script>
    <script src="./js/vendor/codemirror/addon/lint/lint.js"></script>
    <script src="./js/vendor/codemirror/addon/lint/javascript-lint.js"></script>
    <!-- Design mode requirements -->
    <link rel="stylesheet" href="./styles/kidoju.tools.css">
    <link rel="stylesheet" href="./styles/kidoju.widgets.explorer.css">
    <link rel="stylesheet" href="./styles/kidoju.widgets.navigation.css">
    <link rel="stylesheet" href="./styles/kidoju.widgets.stage.css">
    <link rel="stylesheet" href="./styles/kidoju.widgets.toolbox.css">
    <script src="js/kidoju.data.js"></script>
    <script src="./js/kidoju.tools.js"></script>
    <script src="./js/kidoju.widgets.bindings.js"></script>
    <script src="./js/kidoju.widgets.explorer.js"></script>
    <script src="./js/kidoju.widgets.navigation.js"></script>
    <script src="./js/kidoju.widgets.stage.js"></script>
    <script src="./js/kidoju.widgets.toolbox.js"></script>
    <script src="./js/kidoju.widgets.propertygrid.js"></script>
    <style>
        html, body {
            font: 14px sans-serif;
            margin: 0;
            width: 100%;
            height: 100%;
        }
        header {
            height: 48px;
            background-color: #001111;
        }
        header>img {
            padding: 2px 5px;
        }
        footer {
            position: absolute;
            height: 35px;
            bottom: 0px;
        }
        footer>div {
            padding: 8px;
        }
        .noscroll {
            scrollable: false;
        }
        main>[data-role="splitter"] {
            position: absolute;
            left: 0;
            right: 0;
            height: auto;
            top: 92px;
            bottom: 35px;
            border-width: 0 0 1px;
        }
    </style>
</head>
<body>
    <header>
        <img src="https://raw.githubusercontent.com/Memba/Kidoju-Webapp/master/webapp/public/styles/images/KdjLogoBB.png" alt="Kidoju Logo">
    </header>
    <main>
        <div data-role="toolbar"></div>
        <div data-role="splitter" data-panes="[{min: 100, max:400, size: 300}, {}, {min: 100, max:400, size: 300}]">
            <div id="left-pane">
                <div data-role="navigation" data-bind="source: stream.pages, value: currentPage"></div>
            </div>
            <div id="center-pane">
                <div class="centered">
                    <div data-role="stage" data-bind="source: currentPage.components, value: currentComponent" data-mode="design"></div>
                </div>
            </div>
            <div id="right-pane">
                <div class="noscroll">
                    <ul data-role="panelbar">
                        <li>
                            Toolbox
                            <div data-role="toolbox"></div>
                        </li>
                        <li>
                            Explorer
                            <div data-role="explorer" data-bind="source: currentPage.components, value: currentComponent"></div>
                        </li>
                        <li>
                            Attributes
                            <div id="attributes" data-role="propertygrid" data-bind="value: currentComponent"></div>
                        </li>
                        <li>
                            Properties
                            <div id="properties" data-role="propertygrid" data-bind="value: currentComponent"></div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </main>
    <footer>
        <div>Copyright &copy; 2013-2015 Memba Sarl. All rights reserved.</div>
    </footer>
    <script>
        ;(function(window, $, undefined){

            'use strict';

            //LocalStream with localStorage methods
            var storageKey = 'kidoju.integration',
                LocalStream = kidoju.Stream.define({
                    load: function() {
                        var that = this,
                            dfd = $.Deferred(),
                            stream = localStorage.getItem(storageKey),
                            pages = [];
                        if($.type(stream) === 'string') {
                            try {
                                stream = $.parseJSON(stream);
                            } catch(e) {
                                stream = {};
                            }
                        }
                        if($.isArray(stream.pages)) {
                            pages = stream.pages.slice();
                        }
                        stream.pages = undefined;
                        that.accept(stream);
                        that.pages = new kidoju.PageCollectionDataSource({data: pages});
                        that.pages.fetch()
                            .done(function() {
                                var promises = [];
                                $.each(that.pages.data(), function(index, page) {
                                    promises.push(page.components.fetch());
                                });
                                $.when.apply($, promises)
                                    .done(dfd.resolve)
                                    .fail(dfd.reject);
                            })
                            .fail(dfd.reject);
                        return dfd.promise();
                    },
                    save: function() {
                        //TODO: check changes and avoid saving without changes
                        var that = this,
                            dfd = $.Deferred();
                        if (that.isNew()) {
                            that.accept({id: kendo.guid()});
                        }
                        var data = $.extend(that.toJSON(), { pages : [] });
                        $.each(that.pages.data(), function(pageIdx, page){
                            if (page.isNew()) {
                                page.accept({id: kendo.guid()});
                            }
                            if (page.dirty) {
                                page.dirty = false;
                            }
                            data.pages.push($.extend(page.toJSON(), { components: [] }));
                            $.each(page.components.data(), function(componentIdx, component) {
                                if (component.isNew()) {
                                    component.accept({id: kendo.guid()});
                                }
                                if (component.dirty) {
                                    component.dirty = false;
                                }
                                data.pages[data.pages.length - 1].components.push(component.toJSON());
                            });
                        });
                        localStorage.setItem(storageKey, kendo.stringify(data));
                        return dfd.resolve().promise();
                    }
                }),
                streamData = {
                    "id": "a795f4da-a38b-459a-8709-63529faa7a5b",
                    "pages": [{
                        "id": "000574bf-eae6-427c-99ff-0fae9c20c74b",
                        "components": [{
                            "id": "881e9724-7590-4bd8-856c-3e8f2e43cf26",
                            "tool": "image",
                            "top": 50,
                            "left": 370,
                            "height": 250,
                            "width": 250,
                            "rotate": 0,
                            "tag": null,
                            "attributes": {
                                "src": "http://marketingland.com/wp-content/ml-loads/2013/04/google-g-logo-2012.png",
                                "alt": "",
                                "dirty": false
                            },
                            "properties": {"dirty": false}
                        }, {
                            "id": "fbc75ed3-e459-449e-9ae0-5244c270d03c",
                            "tool": "label",
                            "top": 305.769653320313,
                            "left": 114.216812133789,
                            "height": 103.38539553752535,
                            "width": 812.1719630380888,
                            "rotate": 0,
                            "tag": null,
                            "attributes": {
                                "text": "What is this company?",
                                "style": "font-family: Georgia, serif; color: #0000FF;",
                                "dirty": false
                            },
                            "properties": {"dirty": false}
                        }, {
                            "id": "c62d4e8e-2692-4959-a38f-0588dc73d255",
                            "tool": "quiz",
                            "top": 405.632720947266,
                            "left": 346.598449707031,
                            "height": 328.8460671624972,
                            "width": 404.75839531214785,
                            "rotate": 0,
                            "tag": null,
                            "attributes": {
                                "labelStyle": "color:#0000FF;",
                                "radioStyle": "",
                                "text1": "Google",
                                "text2": "Apple",
                                "text3": "Microsoft",
                                "text4": "IBM",
                                "dirty": false
                            },
                            "properties": {
                                "name": "val_544da5",
                                "description": "What is this company?",
                                "solution": "1",
                                "validation": "function validate(value, solution) {\n\treturn typeof value === \"string\" && typeof solution === \"string\" &&\n\t\tvalue.trim().toUpperCase() === solution.trim().toUpperCase();\n}",
                                "success": 1,
                                "failure": -0.25,
                                "omit": 0,
                                "dirty": false
                            },
                            "ns": ""
                        }]
                    }, {
                        "id": "a4178055-65a7-4fef-b22d-9d928b2f1f32",
                        "components": [{
                            "id": "04d9eedb-0e3b-4dbd-b637-2a4a7eb36eba",
                            "tool": "label",
                            "top": 143.07640288556954,
                            "left": 154.22131658024924,
                            "height": 109.15393283750282,
                            "width": 722.3932837502817,
                            "rotate": 0,
                            "tag": null,
                            "attributes": {
                                "text": "What year did Elvis die?",
                                "style": "font-family: Georgia, serif; color: #FF0000;",
                                "dirty": false
                            },
                            "properties": {"dirty": false}
                        }, {
                            "id": "68fc850f-14e6-4580-87e7-b9f61fd6e5e8",
                            "tool": "textbox",
                            "top": 317.1709420851335,
                            "left": 354.66807742201587,
                            "height": 100,
                            "width": 300,
                            "rotate": 0,
                            "tag": null,
                            "attributes": {"style": "", "dirty": false},
                            "properties": {
                                "name": "val_cc5522",
                                "description": "Year Elvis died",
                                "solution": "1977",
                                "validation": "function validate(value, solution) {\n\treturn typeof value === \"string\" && typeof solution === \"string\" &&\n\t\tvalue.trim().toUpperCase() === solution.trim().toUpperCase();\n}",
                                "success": 1,
                                "failure": -0.25,
                                "omit": 0,
                                "dirty": false
                            },
                            "ns": ""
                        }]
                    }, {
                        "id": "c60e5d19-eaa4-4b5b-a7d1-9bda6ee37d62",
                        "components": [{
                            "id": "0b2f712b-f8d9-4034-b968-a795f5091ac6",
                            "tool": "image",
                            "top": 196.4001471016735,
                            "left": 51.04672077085242,
                            "height": 471.5551048005409,
                            "width": 380.39441063781834,
                            "rotate": 0,
                            "tag": null,
                            "attributes": {
                                "src": "http://uploads2.wikiart.org/images/pablo-picasso/self-portrait-1907.jpg",
                                "alt": "",
                                "dirty": false
                            },
                            "properties": {"dirty": false}
                        }, {
                            "id": "882cbcd0-76e9-4100-b087-d7f77320c910",
                            "tool": "label",
                            "top": 72.0922779249183,
                            "left": 107.42761017595447,
                            "height": 103.46179851250845,
                            "width": 803.1147171512283,
                            "rotate": 0,
                            "tag": null,
                            "attributes": {
                                "text": "Who painted this self portrait?",
                                "style": "font-family: Georgia, serif; color: #FF0000;",
                                "dirty": false
                            },
                            "properties": {"dirty": false}
                        }, {
                            "id": "7dd82e58-782e-436a-ba94-c68b79500c56",
                            "tool": "quiz",
                            "top": 249.39901733398438,
                            "left": 455.8208923339844,
                            "height": 300,
                            "width": 500,
                            "rotate": 0,
                            "tag": null,
                            "attributes": {
                                "labelStyle": "",
                                "radioStyle": "",
                                "text1": "Georges Braque",
                                "text2": "Pablo Picasso",
                                "text3": "Francis Bacon",
                                "text4": "Fernand Léger",
                                "dirty": false
                            },
                            "properties": {
                                "name": "val_7c6b20",
                                "description": "Self portrait",
                                "solution": "2",
                                "validation": "function validate(value, solution) {\n\treturn typeof value === \"string\" && typeof solution === \"string\" &&\n\t\tvalue.trim().toUpperCase() === solution.trim().toUpperCase();\n}",
                                "success": 1,
                                "failure": -0.25,
                                "omit": 0,
                                "dirty": false
                            },
                            "ns": ""
                        }]
                    }]
                };

            //Create some dummy data
            if (!window.localStorage.getItem(storageKey)) {
                window.localStorage.setItem(storageKey, kendo.stringify(streamData));
            }

            //Define viewModel
            var viewModel = window.viewModel = kendo.observable({
                    stream: new LocalStream(),
                    currentPage: undefined,
                    currentComponent: undefined
            });

            //Bind change event to map rows
            viewModel.bind('change', function(e) {
                if(e.field === 'currentPage') {
                    viewModel.set('currentComponent', undefined);
                } else if(e.field === 'currentComponent') {
                    var tool = kidoju.tools[e.sender.get('currentComponent.tool')];
                    if (tool instanceof kidoju.Tool) {
                        var grid1 = $('#attributes').data('kendoPropertyGrid'),
                            grid2 = $('#properties').data('kendoPropertyGrid');
                        if (grid1) {
                            grid1.rows(tool._getAttributeRows());
                        }
                        if (grid2) {
                            grid2.rows(tool._getPropertyRows());
                        }
                    }
                }
            });

            //onResize event handler
            function onResize() {
                var navigationWidget = $('[data-role="navigation"]').data('kendoNavigation'),
                    stage = $('#center-pane [data-role="stage"]'),
                    stageWidget = stage.data('kendoStage');
                if (navigationWidget instanceof kendo.ui.Navigation) {
                    navigationWidget.resize();
                }
                if (stageWidget instanceof kendo.ui.Stage) {
                    var width = $('#center-pane').width(),
                        height = $('#center-pane').height(),
                        scale = Math.min(0.90*width/1024, 0.90*height/768);
                    stageWidget.scale(scale);
                    $('.centered')
                        .width(scale*stage.outerWidth())
                        .height(scale*stage.outerHeight())
                        .css('position', 'absolute')
                        .css('top', '50%')
                        .css('left', '50%')
                        .css('margin-left', '-' + scale*stage.outerWidth()/2 + 'px')
                        .css('margin-top', '-' + scale*stage.outerHeight()/2 + 'px');
                }
            }

            //When document is ready...
            $(document).ready(function() {

                //Init toolbar
                $(kendo.roleSelector('toolbar')).kendoToolBar({
                    items: [
                        { id: 'add', type: 'button', text: 'Add Page'},
                        { id: 'delete', type: 'button', text: 'Delete Page'},
                        { id: 'save', type: 'button', text: 'Save'},
                        { id: 'reset', type: 'button', text: 'Reset'},
                        { id: 'play', type: 'button', text: 'Play', primary: true}
                    ],
                    click: function(e) {
                        switch(e.id) {
                            case 'add':
                                viewModel.stream.pages.add({}); //consider index position
                                break;
                            case 'delete':
                                var navigation = $(kendo.roleSelector('navigation')).data('kendoNavigation');
                                if (navigation instanceof kendo.ui.Navigation) {
                                    var page = navigation.value();
                                    if (page instanceof kidoju.Page) {
                                        viewModel.stream.pages.remove(page);
                                    }
                                }
                                break;
                            case 'save':
                                viewModel.stream.save();
                                break;
                            case 'reset':
                                window.localStorage.setItem(storageKey, kendo.stringify(streamData));
                                viewModel.stream.load().then(function() {
                                    window.viewModel.set('currentPage', viewModel.stream.pages.at(0));
                                });
                                break;
                            case 'play':
                                window.location.assign('kidoju.integration.playmode.html');
                                break;
                        }
                    }
                });

                //Load stream
                viewModel.stream.load().then(function() {
                    window.viewModel.set('currentPage', viewModel.stream.pages.at(0));
                    kendo.bind('body', viewModel);
                });

                //Bind resize events and resize
                $('main [data-role="splitter"]').data('kendoSplitter').bind('resize', onResize);
                $(window).on('resize', onResize);
                onResize();
            });

        }(this, jQuery));
    </script>
</body>
</html>
