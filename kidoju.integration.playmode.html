<!DOCTYPE html>
<html>
<head>
    <title>kidoju.integration.playmode</title>
    <script>
        window.app = { DEBUG: true };
    </script>
    <link href="http://cdn.kendostatic.com/2015.2.624/styles/kendo.common.min.css" rel="stylesheet">
    <link href="http://cdn.kendostatic.com/2015.2.624/styles/kendo.default.min.css" rel="stylesheet">
    <link href="http://cdn.kendostatic.com/2015.2.624/styles/kendo.default.mobile.min.css" rel="stylesheet">
    <!-- Unfortunately, the grid is not a Kendo UI Core widget -->
    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script src="http://cdn.kendostatic.com/2015.2.624/js/kendo.all.min.js"></script>
    <!--script src="./js/vendor/kendo/jquery.min.js"></script>
    <script src="./js/vendor/kendo/kendo.core.js"></script>
    <script src="./js/vendor/kendo/kendo.data.js"></script>
    <script src="./js/vendor/kendo/kendo.binder.js"></script>
    <script src="./js/vendor/kendo/kendo.userevents.js"></script>
    <script src="./js/vendor/kendo/kendo.draganddrop.js"></script>
    <script src="./js/vendor/kendo/kendo.popup.js"></script>
    <script src="./js/vendor/kendo/kendo.listview.js"></script>
    <script src="./js/vendor/kendo/kendo.menu.js"></script-->
    <!-- Play mode requirements -->
    <!--link rel="stylesheet" href="./styles/kidoju.widgets.playbar.css"-->
    <link rel="stylesheet" href="./styles/kidoju.widgets.stage.css">
    <script src="./js/kidoju.data.js"></script>
    <script src="./js/kidoju.tools.js"></script>
    <script src="./js/kidoju.widgets.bindings.js"></script>
    <script src="./js/kidoju.widgets.playbar.js"></script>
    <script src="./js/kidoju.widgets.stage.js"></script>
    <style>
        html, body {
            font: 14px sans-serif;
            margin: 0;
            width: 100%;
            height: 100%;
        }
        header {
            height: 48px;
            background-color: #001111;
        }
        header>img {
            padding: 2px 5px;
        }
        #wrapper {
            position: absolute;
            left: 0;
            right: 0;
            height: auto;
            border: none;
            top: 89px;
            bottom: 36px;
            overflow-y: scroll;
        }
        div.k-block div:last-of-type {
            font-size: 48px;
            font-weight: bolder;
            text-align: center;
        }
        footer {
            position: absolute;
            height: 35px;
            bottom: 0px;
            border-top: solid 1px #c5c5c5;
            width: 100%;
        }
        footer>div {
            padding: 8px;
        }
    </style>
</head>
<body>
<header>
    <img src="./styles/images/KdjLogoBB.png" alt="Kidoju Logo">
</header>
<main>
    <div data-role="playbar" data-bind="source: stream.pages, value: currentPage, events: {click: calculate}"></div>
    <div id="wrapper" class="k-content">
        <div class="centered">
            <div data-role="stage" data-bind="source: currentPage.components, properties: test" data-mode="play"></div>
            <div style="display: none">
                <div class="k-block k-info-colored">
                    <div class="k-header">Your Score</div>
                    <div data-bind="text: result.percent"></div>
                </div>
                <div data-role="grid"></div>
            </div>
        </div>
    </div>
</main>
<footer>
    <div>Copyright &copy; 2013-2015 Memba Sarl. All rights reserved.</div>
</footer>
<script>

    //LocalStream with localStorage methods
    var storageKey = 'kidoju.integration',
        LocalStream = kidoju.Stream.define({
            load: function() {
                var that = this,
                    dfd = $.Deferred(),
                    stream = localStorage.getItem(storageKey),
                    pages = [];
                if($.type(stream) === 'string') {
                    try {
                        stream = $.parseJSON(stream);
                    } catch(e) {
                        stream = {};
                    }
                }
                if($.isArray(stream.pages)) {
                    pages = stream.pages.slice();
                }
                stream.pages = undefined;
                that.accept(stream);
                that.pages = new kidoju.PageCollectionDataSource({data: pages});
                that.pages.fetch()
                    .done(function() {
                        var promises = [];
                        $.each(that.pages.data(), function(index, page) {
                            promises.push(page.components.fetch());
                        });
                        $.when.apply($, promises)
                            .done(dfd.resolve)
                            .fail(dfd.reject);
                    })
                    .fail(dfd.reject);
                return dfd.promise();
            },
            save: function() {
                //TODO: check changes and avoid saving without changes
                var that = this,
                    dfd = $.Deferred();
                if (that.isNew()) {
                    that.accept({id: kendo.guid()});
                }
                var data = $.extend(that.toJSON(), { pages : [] });
                $.each(that.pages.data(), function(pageIdx, page){
                    if (page.isNew()) {
                        page.accept({id: kendo.guid()});
                    }
                    if (page.dirty) {
                        page.dirty = false;
                    }
                    data.pages.push($.extend(page.toJSON(), { components: [] }));
                    $.each(page.components.data(), function(componentIdx, component) {
                        if (component.isNew()) {
                            component.accept({id: kendo.guid()});
                        }
                        if (component.dirty) {
                            component.dirty = false;
                        }
                        data.pages[data.pages.length - 1].components.push(component.toJSON());
                    });
                });
                localStorage.setItem(storageKey, kendo.stringify(data));
                return dfd.resolve().promise();
            }
        }),
        streamData = {
            "id": "a795f4da-a38b-459a-8709-63529faa7a5b",
            "pages": [{
                "id": "000574bf-eae6-427c-99ff-0fae9c20c74b",
                "components": [{
                    "id": "881e9724-7590-4bd8-856c-3e8f2e43cf26",
                    "tool": "image",
                    "top": 50,
                    "left": 370,
                    "height": 250,
                    "width": 250,
                    "rotate": 0,
                    "tag": null,
                    "attributes": {
                        "src": "http://marketingland.com/wp-content/ml-loads/2013/04/google-g-logo-2012.png",
                        "alt": "",
                        "dirty": false
                    },
                    "properties": {"dirty": false}
                }, {
                    "id": "fbc75ed3-e459-449e-9ae0-5244c270d03c",
                    "tool": "label",
                    "top": 305.769653320313,
                    "left": 114.216812133789,
                    "height": 103.38539553752535,
                    "width": 812.1719630380888,
                    "rotate": 0,
                    "tag": null,
                    "attributes": {
                        "text": "What is this company?",
                        "style": "font-family: Georgia, serif; color: #0000FF;",
                        "dirty": false
                    },
                    "properties": {"dirty": false}
                }, {
                    "id": "c62d4e8e-2692-4959-a38f-0588dc73d255",
                    "tool": "quiz",
                    "top": 405.632720947266,
                    "left": 346.598449707031,
                    "height": 328.8460671624972,
                    "width": 404.75839531214785,
                    "rotate": 0,
                    "tag": null,
                    "attributes": {
                        "labelStyle": "color:#0000FF;",
                        "radioStyle": "",
                        "text1": "Google",
                        "text2": "Apple",
                        "text3": "Microsoft",
                        "text4": "IBM",
                        "dirty": false
                    },
                    "properties": {
                        "name": "val_544da5",
                        "description": "What is this company?",
                        "solution": "1",
                        "validation": "function validate(value, solution) {\n\treturn typeof value === \"string\" && typeof solution === \"string\" &&\n\t\tvalue.trim().toUpperCase() === solution.trim().toUpperCase();\n}",
                        "success": 1,
                        "failure": -0.25,
                        "omit": 0,
                        "dirty": false
                    },
                    "ns": ""
                }]
            }, {
                "id": "a4178055-65a7-4fef-b22d-9d928b2f1f32",
                "components": [{
                    "id": "04d9eedb-0e3b-4dbd-b637-2a4a7eb36eba",
                    "tool": "label",
                    "top": 143.07640288556954,
                    "left": 154.22131658024924,
                    "height": 109.15393283750282,
                    "width": 722.3932837502817,
                    "rotate": 0,
                    "tag": null,
                    "attributes": {
                        "text": "What year did Elvis die?",
                        "style": "font-family: Georgia, serif; color: #FF0000;",
                        "dirty": false
                    },
                    "properties": {"dirty": false}
                }, {
                    "id": "68fc850f-14e6-4580-87e7-b9f61fd6e5e8",
                    "tool": "textbox",
                    "top": 317.1709420851335,
                    "left": 354.66807742201587,
                    "height": 100,
                    "width": 300,
                    "rotate": 0,
                    "tag": null,
                    "attributes": {"style": "", "dirty": false},
                    "properties": {
                        "name": "val_cc5522",
                        "description": "Year Elvis died",
                        "solution": "1977",
                        "validation": "function validate(value, solution) {\n\treturn typeof value === \"string\" && typeof solution === \"string\" &&\n\t\tvalue.trim().toUpperCase() === solution.trim().toUpperCase();\n}",
                        "success": 1,
                        "failure": -0.25,
                        "omit": 0,
                        "dirty": false
                    },
                    "ns": ""
                }]
            }, {
                "id": "c60e5d19-eaa4-4b5b-a7d1-9bda6ee37d62",
                "components": [{
                    "id": "0b2f712b-f8d9-4034-b968-a795f5091ac6",
                    "tool": "image",
                    "top": 196.4001471016735,
                    "left": 51.04672077085242,
                    "height": 471.5551048005409,
                    "width": 380.39441063781834,
                    "rotate": 0,
                    "tag": null,
                    "attributes": {
                        "src": "http://uploads2.wikiart.org/images/pablo-picasso/self-portrait-1907.jpg",
                        "alt": "",
                        "dirty": false
                    },
                    "properties": {"dirty": false}
                }, {
                    "id": "882cbcd0-76e9-4100-b087-d7f77320c910",
                    "tool": "label",
                    "top": 72.0922779249183,
                    "left": 107.42761017595447,
                    "height": 103.46179851250845,
                    "width": 803.1147171512283,
                    "rotate": 0,
                    "tag": null,
                    "attributes": {
                        "text": "Who painted this self portrait?",
                        "style": "font-family: Georgia, serif; color: #FF0000;",
                        "dirty": false
                    },
                    "properties": {"dirty": false}
                }, {
                    "id": "7dd82e58-782e-436a-ba94-c68b79500c56",
                    "tool": "quiz",
                    "top": 249.39901733398438,
                    "left": 455.8208923339844,
                    "height": 300,
                    "width": 500,
                    "rotate": 0,
                    "tag": null,
                    "attributes": {
                        "labelStyle": "",
                        "radioStyle": "",
                        "text1": "Georges Braque",
                        "text2": "Pablo Picasso",
                        "text3": "Francis Bacon",
                        "text4": "Fernand Léger",
                        "dirty": false
                    },
                    "properties": {
                        "name": "val_7c6b20",
                        "description": "Self portrait",
                        "solution": "2",
                        "validation": "function validate(value, solution) {\n\treturn typeof value === \"string\" && typeof solution === \"string\" &&\n\t\tvalue.trim().toUpperCase() === solution.trim().toUpperCase();\n}",
                        "success": 1,
                        "failure": -0.25,
                        "omit": 0,
                        "dirty": false
                    },
                    "ns": ""
                }]
            }, {
                "id": "d2350965-9c39-4666-8d64-9a2111e9f486",
                "style": "",
                "components": [{
                    "id": "ecfd9684-330c-4817-b670-bfcf27e28935",
                    "tool": "image",
                    "top": 155.0581455417471,
                    "left": 218.753723144531,
                    "height": 592.2051936994466,
                    "width": 569.318859088974,
                    "rotate": 0,
                    "tag": null,
                    "attributes": {
                        "src": "http://static.intellego.fr/uploads/8/4/84305/media/HistoireGeographie/carte%20de%20france%20fleuve%20vide.GIF",
                        "alt": "French Map",
                        "dirty": false
                    },
                    "properties": {"dirty": false}
                }, {
                    "id": "2bbd052d-4c60-4412-8709-492063197481",
                    "tool": "label",
                    "top": 44.9261779785156,
                    "left": 108.87930297851597,
                    "height": 95.6406981694338,
                    "width": 787.1519795657726,
                    "rotate": 0,
                    "tag": null,
                    "attributes": {
                        "text": "Name the rivers on the map",
                        "style": "font-family: Georgia, serif; color: #000000;",
                        "dirty": false
                    },
                    "properties": {"dirty": false}
                }, {
                    "id": "f96497f1-8c69-4ed1-bd52-1a80a52afdb9",
                    "tool": "textbox",
                    "top": 266.09390892785615,
                    "left": 412.3641901645526,
                    "height": 46.59855257556407,
                    "width": 186.65815240527883,
                    "rotate": 0,
                    "tag": null,
                    "attributes": {"style": "opacity:0.7;", "dirty": false},
                    "properties": {
                        "name": "val_924bf9",
                        "description": "",
                        "solution": "Seine",
                        "validation": "function validate(value, solution) {\n\treturn typeof value === \"string\" && typeof solution === \"string\" &&\n\t\tvalue.trim().toUpperCase() === solution.trim().toUpperCase();\n}",
                        "success": 1,
                        "failure": 0,
                        "omit": 0,
                        "dirty": false
                    },
                    "ns": ""
                }, {
                    "id": "f884a6bc-1467-4357-b735-90836dec484f",
                    "tool": "textbox",
                    "top": 342.3753052667238,
                    "left": 345.5080811820069,
                    "height": 54.22733077905492,
                    "width": 191.01745423584504,
                    "rotate": 0,
                    "tag": null,
                    "attributes": {"style": "opacity:0.7;", "dirty": false},
                    "properties": {
                        "name": "val_082890",
                        "description": "",
                        "solution": "Loire",
                        "validation": "function validate(value, solution) {\n\treturn typeof value === \"string\" && typeof solution === \"string\" &&\n\t\tvalue.trim().toUpperCase() === solution.trim().toUpperCase();\n}",
                        "success": 1,
                        "failure": 0,
                        "omit": 0,
                        "dirty": false
                    },
                    "ns": ""
                }, {
                    "id": "ee2499b8-8915-46fb-b1ba-d9e15e40ef66",
                    "tool": "textbox",
                    "top": 550.2497199112534,
                    "left": 298.62174657153435,
                    "height": 50.95785440613027,
                    "width": 200.825883354619,
                    "rotate": 0,
                    "tag": null,
                    "attributes": {"style": "opacity:0.7;", "dirty": false},
                    "properties": {
                        "name": "val_f9e548",
                        "description": "",
                        "solution": "Garonne",
                        "validation": "function validate(value, solution) {\n\treturn typeof value === \"string\" && typeof solution === \"string\" &&\n\t\tvalue.trim().toUpperCase() === solution.trim().toUpperCase();\n}",
                        "success": 1,
                        "failure": 0,
                        "omit": 0,
                        "dirty": false
                    },
                    "ns": ""
                }, {
                    "id": "25fcee00-94c9-493a-af8c-228af5b436d0",
                    "tool": "textbox",
                    "top": 558.8784981147442,
                    "left": 522.7656375889885,
                    "height": 46.59855257556407,
                    "width": 191.01745423584504,
                    "rotate": 0,
                    "tag": null,
                    "attributes": {"style": "opacity:0.7;", "dirty": false},
                    "properties": {
                        "name": "val_ac8c11",
                        "description": "",
                        "solution": "Rhône",
                        "validation": "function validate(value, solution) {\n\treturn typeof value === \"string\" && typeof solution === \"string\" &&\n\t\tvalue.trim().toUpperCase() === solution.trim().toUpperCase();\n}",
                        "success": 1,
                        "failure": 0,
                        "omit": 0,
                        "dirty": false
                    },
                    "ns": ""
                }]
            }]
        };

    //Create some dummy data
    if (!window.localStorage.getItem(storageKey)) {
        window.localStorage.setItem(storageKey, kendo.stringify(streamData));
    }

    //Define viewModel
    var viewModel = window.viewModel = kendo.observable({
        stream: new LocalStream(),
        currentPage: undefined,
        test: undefined,
        result: undefined,
        calculate: function() {
            viewModel.stream.pages.validateTestFromProperties(window.viewModel.get('test')).then(function(result) {
                window.viewModel.set('result', result);
                var grid = $('div[data-role="grid"]').data('kendoGrid');
                grid.setDataSource(new kendo.data.DataSource({ data: result.getScoreArray() }));
                var sections = $('div.centered>div');
                sections.first().css('display', 'none');
                sections.last().css('display', 'block');
            });
        }
    });

    /**
     * Resize event handler
     */
    function onResize() {
        var stage = $(kendo.roleSelector('stage')),
            stageWidget = stage.data('kendoStage');
        if (stageWidget instanceof kendo.ui.Stage) {
            var width = $('#wrapper').width(),
                height = $('#wrapper').height(),
                scale = Math.min(0.90*width/1024, 0.90*height/768);
            stageWidget.scale(scale);
            $('.centered')
                .width(scale*stage.outerWidth())
                .height(scale*stage.outerHeight())
                .css('position', 'absolute')
                .css('top', '50%')
                .css('left', '50%')
                .css('margin-left', '-' + scale*stage.outerWidth()/2 + 'px')
                .css('margin-top', '-' + scale*stage.outerHeight()/2 + 'px');
        }
    }
    $(window).on('resize', onResize);

    $(document).ready(function() {
        viewModel.stream.load().then(function() {
            viewModel.set('currentPage', viewModel.stream.pages.at(0));
            viewModel.set('test', viewModel.stream.pages.getTestFromProperties());
            kendo.bind('body', viewModel);
            onResize();
        });

    });

</script>
</body>
</html>
